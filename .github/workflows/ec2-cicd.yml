name: EC2 CI/CD

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: ec2-cicd-main
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install backend deps
        run: pip install -r requirements/dev.txt

      - name: Run backend unit tests
        run: pytest -q tests/unit

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: apps/frontend/package-lock.json

      - name: Install frontend deps
        run: npm --prefix apps/frontend ci

      - name: Run frontend tests
        run: npm --prefix apps/frontend run test:run

  deploy:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'workflow_dispatch' && secrets.EC2_HOST != '' && secrets.EC2_USER != '' && secrets.EC2_SSH_KEY != ''
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Package release
        run: |
          tar \
            --exclude='.git' \
            --exclude='.venv' \
            --exclude='node_modules' \
            --exclude='apps/frontend/node_modules' \
            -czf release.tgz .

      - name: Upload release to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: release.tgz
          target: "~"

      - name: Deploy on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script_stop: true
          script: |
            set -euo pipefail
            APP_DIR="${APP_DIR:-$HOME/torre-screening}"
            mkdir -p "$APP_DIR"
            tar -xzf "$HOME/release.tgz" -C "$APP_DIR"
            cd "$APP_DIR"

            if [ ! -f .env.ec2 ]; then
              cp .env.ec2.example .env.ec2
              echo ".env.ec2 was created from template. Set real values and rerun workflow."
              exit 1
            fi

            docker compose --env-file .env.ec2 -f docker-compose.ec2.yml up -d --build --remove-orphans
            docker image prune -f
